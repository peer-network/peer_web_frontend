name: Security Scan

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    branches:
      - main
      - development

  push:
    branches:
      - main
      - development

jobs:
  auto_update_branch:
    name: Auto-Update PR Branch
    uses: peer-network/.github/.github/workflows/auto-update-pr.yml@main
    with:
      pull_request_b64: ${{ github.event_name == 'pull_request' && github.event.pull_request && (github.event.pull_request | toJson | toBase64) || '' }}
    secrets: inherit

  check_branch_sync:
    name: Check if PR Branch is Behind Base
    runs-on: ubuntu-latest
    needs: [auto_update_branch]
    outputs:
      is_behind: ${{ steps.check.outputs.is_behind }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: |
          git fetch origin +refs/heads/*:refs/remotes/origin/*

      - id: check
        run: |
          base_branch="${{ github.event.pull_request.base.ref }}"
          pr_branch="${{ github.event.pull_request.head.ref }}"

          echo "Comparing $pr_branch against $base_branch"
          behind=$(git rev-list --left-right --count origin/${base_branch}...origin/${pr_branch} | awk '{print $1}')

          if [ "$behind" -gt 0 ]; then
            echo "Branch is behind!"
            echo "is_behind=true" >> $GITHUB_OUTPUT
          else
            echo "Branch is up-to-date."
            echo "is_behind=false" >> $GITHUB_OUTPUT
          fi

  fail_outdated_branch:
    name: Block CI Due to Outdated Branch
    runs-on: ubuntu-latest
    needs: [check_branch_sync]
    if: needs.check_branch_sync.outputs.is_behind == 'true'
    steps:
      - run: |
          echo " PR branch is behind the base branch."
          exit 1

  map_pr_to_discord:
    name: Map PR to Discord User
    runs-on: ubuntu-latest
    outputs:
      discord_mention: ${{ steps.map.outputs.discord_mention }}
    steps:
      - name: Map GitHub username to Discord ID
        id: map
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "discord_mention=<@1362087975906967736>" >> $GITHUB_OUTPUT
            exit 0
          fi

          case "${{ github.event.pull_request.user.login }}" in
            WisdomNwaiwu)
              echo "discord_mention=<@1362087975906967736>" >> $GITHUB_OUTPUT
              ;;
            jakobPeer)
              echo "discord_mention=<@1334087880833892392>" >> $GITHUB_OUTPUT
              ;;
            Yungsegz)
              echo "discord_mention=<@1354259999442079891>" >> $GITHUB_OUTPUT
              ;;
            khalidmeraj)
              echo "discord_mention=<@1370332220094414908>" >> $GITHUB_OUTPUT
              ;;
            LuqmanUddin0007)
              echo "discord_mention=<@1367037547011641407>" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "discord_mention=<@1362087975906967736>" >> $GITHUB_OUTPUT
              ;;
          esac

  gitleaks:
    name: Run Gitleaks Scan
    needs: [auto_update_branch, map_pr_to_discord, check_branch_sync]
    if: needs.check_branch_sync.outputs.is_behind == 'false'
    uses: peer-network/peer_global_security/.github/workflows/gitleaks.yml@main
    with:
      config: gitleaks.toml

  trivy_scan:
    name: Run Trivy Security Scan
    needs: [auto_update_branch, map_pr_to_discord, check_branch_sync]
    if: needs.check_branch_sync.outputs.is_behind == 'false'
    uses: peer-network/.github/.github/workflows/trivy-scan.yml@main
    with:
      scan_target: .

  determine_event_type:
    name: Determine Discord Event Type
    runs-on: ubuntu-latest
    needs: [check_branch_sync, gitleaks, trivy_scan]
    outputs:
      event_type: ${{ steps.set_type.outputs.event_type }}
    steps:
      - id: set_type
        run: |
          if [ "${{ needs.check_branch_sync.outputs.is_behind }}" == "true" ]; then
            echo "event_type=behind" >> $GITHUB_OUTPUT

          elif [ "${{ needs.gitleaks.result }}" == "failure" ]; then
            echo "event_type=gitleaks_failed" >> $GITHUB_OUTPUT

          elif [ "${{ needs.trivy_scan.outputs.has_findings }}" == "true" ]; then
            echo "event_type=trivy_vulnerabilities" >> $GITHUB_OUTPUT

          else
            echo "event_type=success" >> $GITHUB_OUTPUT
          fi

  send_discord_notification:
    name: Unified Discord Notification
    needs: [
      check_branch_sync,
      gitleaks,
      trivy_scan,
      final_check,
      map_pr_to_discord,
      determine_event_type
    ]
    if: always()
    uses: peer-network/.github/.github/workflows/discord-notify.yml@main
    with:
      repo_name: "Web Frontend"
      event_type: ${{ needs.determine_event_type.outputs.event_type }}
      pr_title: ${{ github.event.pull_request.title }}
      pr_url: ${{ github.event.pull_request.html_url }}
      run_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      discord_mention: ${{ needs.map_pr_to_discord.outputs.discord_mention }}
    secrets:
      webhook: ${{ secrets.WEBAPP_DISCORD }}

  final_check:
    name: Final Check - Fail if Any Critical Job Failed
    runs-on: ubuntu-latest
    needs: [check_branch_sync, gitleaks, trivy_scan]
    if: always()
    steps:
      - run: |
          if [ "${{ needs.check_branch_sync.outputs.is_behind }}" == "true" ]; then
            echo "Failing: PR branch is behind base branch."
            exit 1
          fi
          if [ "${{ needs.gitleaks.result }}" == "failure" ]; then
            echo "Failing: Gitleaks detected secrets."
            exit 1
          fi
          if [ "${{ needs.gitleaks.result }}" == "skipped" ]; then
            echo "Note: Gitleaks was skipped because branch is outdated."
          fi
          echo "All critical checks passed."